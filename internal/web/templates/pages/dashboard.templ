package pages

import (
	"github.com/mccune1224/betrayal/internal/web/templates/layouts"
	"github.com/mccune1224/betrayal/internal/web/templates/partials"
	"strconv"
)

type CommandActivitySummaryData = partials.CommandActivitySummaryData

type TopCommandData = partials.TopCommandData

type CommandErrorData = partials.CommandErrorData

type DashboardData struct {
	CyclePhase     string
	CycleNumber    int
	PlayersAlive   int
	PlayersDead    int
	TotalPlayers   int
	CommandSummary *CommandActivitySummaryData
	TopCommands    []TopCommandData
	RecentErrors   []CommandErrorData
}

templ Dashboard(data DashboardData) {
	@layouts.Base("Dashboard", "/") {
		<script>
			document.body.addEventListener('redeployStarted', function() {
				// Disable automatic polling
				const statusDiv = document.getElementById('health-status');
				statusDiv.setAttribute('hx-trigger', 'none');

				// Show restarting status
				statusDiv.innerHTML = `
					<div class="flex flex-col gap-3">
						<div class="flex items-center justify-between">
							<span class="text-dust text-base">BOT</span>
							<div class="flex items-center">
								<span class="status-degraded"></span>
								<span class="text-rope text-base font-semibold">RESTARTING</span>
							</div>
						</div>
						<div class="flex items-center justify-between">
							<span class="text-dust text-base">DATABASE</span>
							<div class="flex items-center">
								<span class="status-online"></span>
								<span class="text-sage text-base font-semibold">ONLINE</span>
							</div>
						</div>
						<div class="text-sm text-dust mt-2">
							RESTARTING BOT...
						</div>
						<button
							hx-get="/health/status"
							hx-target="#health-status"
							hx-swap="innerHTML"
							class="btn-ghost mt-2">
							REFRESH
						</button>
					</div>
				`;

				// Re-enable normal polling after 30 seconds
				setTimeout(function() {
					const statusDiv = document.getElementById('health-status');
					statusDiv.setAttribute('hx-trigger', 'load, every 15s');
					// Trigger a refresh
					htmx.trigger(statusDiv, 'load');
				}, 30000);
			});
		</script>
		<h1 class="page-title mb-6">DASHBOARD</h1>

		<!-- Status Cards - Mobile: 1 col, Desktop: 2 col then 3 col -->
		<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
			<!-- Bot Status Card - Most Important -->
			<div class="card">
				<h2 class="text-base text-wood mb-3 border-b-2 border-rope pb-2 font-bold">SYSTEM STATUS</h2>
				<div
					id="health-status"
					hx-get="/health/status"
					hx-trigger="load, every 15s"
					hx-swap="innerHTML">
					<!-- Loading state -->
					<div class="flex items-center justify-center py-4">
						<span class="spinner"></span>
						<span class="ml-2 text-dust text-base">CHECKING...</span>
					</div>
				</div>
			</div>

			<!-- Cycle Status -->
			<div class="card">
				<h2 class="text-base text-wood mb-3 border-b-2 border-rope pb-2 font-bold">CURRENT CYCLE</h2>
				<p class="text-3xl font-western text-leather">
					{ data.CyclePhase }
					<span class="text-rust">{ strconv.Itoa(data.CycleNumber) }</span>
				</p>
			</div>

			<!-- Player Count -->
			<div class="card">
				<h2 class="text-base text-wood mb-3 border-b-2 border-rope pb-2 font-bold">PLAYERS</h2>
				<div class="flex items-baseline gap-4">
					<div>
						<span class="text-3xl font-bold text-sage">{ strconv.Itoa(data.PlayersAlive) }</span>
						<span class="text-sm text-dust ml-1">ALIVE</span>
					</div>
					<div>
						<span class="text-xl text-rust font-bold">{ strconv.Itoa(data.PlayersDead) }</span>
						<span class="text-sm text-dust ml-1">DEAD</span>
					</div>
				</div>
				<p class="text-sm text-dust mt-2">{ strconv.Itoa(data.TotalPlayers) } TOTAL</p>
			</div>

			<!-- Quick Actions -->
			<div class="card">
				<h2 class="text-base text-wood mb-3 border-b-2 border-rope pb-2 font-bold">ACTIONS</h2>
				<button
					id="redeploy-btn"
					hx-post="/admin/redeploy"
					hx-confirm="Are you sure you want to redeploy? This will restart the bot."
					hx-swap="none"
					hx-disabled-elt="this"
					class="btn-danger w-full relative">
					<span class="htmx-hide-on-request">REDEPLOY BOT</span>
					<span class="htmx-indicator items-center justify-center">
						<span class="spinner mr-2"></span>
						RESTARTING...
					</span>
				</button>
			</div>
		</div>

		<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
			<!-- Command Activity -->
			<div class="card">
				<h2 class="text-base text-wood mb-3 border-b-2 border-rope pb-2 font-bold">COMMAND ACTIVITY</h2>
				if data.CommandSummary != nil {
					@partials.CommandSummaryCard(data.CommandSummary)
				} else {
					@partials.EmptyState("No command activity data available")
				}
			</div>

			<!-- Top Commands -->
			<div class="card lg:col-span-2">
				<div class="flex justify-between items-center mb-3 border-b-2 border-rope pb-2">
					<h2 class="text-base text-wood font-bold">TOP COMMANDS (LAST HOUR)</h2>
					<span class="text-rust text-sm font-bold">LIVE</span>
				</div>
				if len(data.TopCommands) > 0 {
					@partials.TopCommandsTable(data.TopCommands)
				} else {
					@partials.EmptyState("No command usage in the last hour")
				}
			</div>

			<!-- Recent Command Errors -->
			<div class="card">
				<div class="flex justify-between items-center mb-3 border-b-2 border-rope pb-2">
					<h2 class="text-base text-wood font-bold">RECENT COMMAND ERRORS</h2>
					<span class="text-rust text-sm font-bold">MONITORING</span>
				</div>
				if len(data.RecentErrors) > 0 {
					@partials.CommandErrorsList(data.RecentErrors)
				} else {
					@partials.EmptyState("No recent failures detected")
				}
			</div>
		</div>

		<!-- Recent Players Section -->
		<div class="card">
			<div class="card-header flex justify-between items-center">
				<h2 class="text-base text-wood font-bold">RECENT PLAYERS</h2>
				<a href="/players" class="table-link">VIEW ALL &#x2192;</a>
			</div>
			<div
				class="overflow-x-auto"
				hx-get="/players/table"
				hx-trigger="load"
				hx-swap="innerHTML">
				<div class="flex items-center justify-center py-8">
					<span class="spinner"></span>
					<span class="ml-2 text-dust text-base">LOADING...</span>
				</div>
			</div>
		</div>
	}
}
